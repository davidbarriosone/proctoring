define(["jquery","core/log","core/notification"],function(e,t,a){var n=null,o=null;async function r(){if(!window.faceapi)return a.alert("Error","face-api.js no está cargado","OK"),!1;o=window.faceapi;try{var e=M.cfg.wwwroot+"/mod/quiz/accessrule/camerasupervision/models";return await o.nets.tinyFaceDetector.loadFromUri(e),await o.nets.faceLandmark68Net.loadFromUri(e),await o.nets.faceRecognitionNet.loadFromUri(e),t.debug("camerasupervision: face-api models loaded"),!0}catch(n){return t.error("camerasupervision: error loading face-api models: "+n),a.alert("Error","No se pudieron cargar los modelos de reconocimiento facial","OK"),!1}}async function i(e){try{var t=await o.detectSingleFace(e,new o.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();return t?Array.from(t.descriptor):null}catch(a){return t.error("camerasupervision: error detecting face: "+a),null}}async function s(){try{n=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}},audio:!1});var t=document.getElementById("camera-video");return t.srcObject=n,e("#camera-container").show(),e("#btn-start-camera").hide(),e("#btn-capture").show(),e("#btn-stop-camera").show(),!0}catch(o){return t.error("camerasupervision: error starting camera: "+o),a.alert("Error","No se pudo acceder a la cámara: "+o.name,"OK"),!1}}function c(){n&&(n.getTracks().forEach(function(e){e.stop()}),n=null);var t=document.getElementById("camera-video");t&&(t.srcObject=null),e("#camera-container").hide(),e("#btn-start-camera").show(),e("#btn-capture").hide(),e("#btn-stop-camera").hide()}async function d(){var o=document.getElementById("camera-video"),r=document.getElementById("camera-canvas");if(!o||r){a.alert("Error","Elementos no encontrados","OK");return}r.width=o.videoWidth,r.height=o.videoHeight;var s=r.getContext("2d");s.drawImage(o,0,0,r.width,r.height),e("#capture-status").html('<div class="alert alert-info">Procesando imagen...</div>');var c=await i(r);if(!c){e("#capture-status").html('<div class="alert alert-danger">No se detectó ningún rostro en la imagen. Por favor, intenta de nuevo asegurándote de que tu rostro esté bien iluminado y centrado.</div>');return}var d=r.toDataURL("image/png"),l=e("#capture-userid").val(),u=e("#capture-sesskey").val();e("#capture-status").html('<div class="alert alert-info">Guardando foto...</div>');var m=new FormData;m.append("userid",l),m.append("image",d),m.append("descriptor",JSON.stringify(c)),m.append("sesskey",u);try{var f=await fetch(M.cfg.wwwroot+"/mod/quiz/accessrule/camerasupervision/upload_face.php",{method:"POST",credentials:"same-origin",body:m}),p=await f.json();"ok"===p.status?(e("#capture-status").html('<div class="alert alert-success">'+p.message+"</div>"),setTimeout(function(){window.location.reload()},2e3)):e("#capture-status").html('<div class="alert alert-danger">'+p.message+"</div>")}catch(g){t.error("camerasupervision: error uploading photo: "+g),e("#capture-status").html('<div class="alert alert-danger">Error al guardar la foto</div>')}}async function l(e){return new Promise(function(t,a){var n=new FileReader;n.onload=async function(n){var o=new Image;o.onload=async function(){var e=await i(o);e?t(e):a(Error("No se detectó rostro en la imagen"))},o.onerror=function(){a(Error("Error al cargar la imagen"))},o.src=n.target.result},n.onerror=function(){a(Error("Error al leer el archivo"))},n.readAsDataURL(e)})}return{init:async function(){if(t.debug("camerasupervision: facemanager init"),await r()){e("#btn-start-camera").on("click",async function(){await s()}),e("#btn-stop-camera").on("click",function(){c()}),e("#btn-capture").on("click",async function(){await d()}),e("form").on("submit",async function(t){var a=e("#photofile")[0];if(!a||!a.files||!a.files[0])return!0;t.preventDefault(),e("#capture-status").html('<div class="alert alert-info">Procesando imagen...</div>');try{var n=await l(a.files[0]),o=e(this);return e("<input>").attr({type:"hidden",name:"descriptor",value:JSON.stringify(n)}).appendTo(o),o.off("submit").submit(),!1}catch(r){e("#capture-status").html('<div class="alert alert-danger">'+r.message+"</div>")}})}}}});
