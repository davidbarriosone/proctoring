define(["jquery","core/log","core/notification"],function(e,t,a){var n=null,o=null;async function r(){if(!window.faceapi)return a.alert("Error","face-api.js no está cargado","OK"),!1;o=window.faceapi;try{var e="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model";return await o.nets.tinyFaceDetector.loadFromUri(e),await o.nets.faceLandmark68Net.loadFromUri(e),await o.nets.faceRecognitionNet.loadFromUri(e),t.debug("camerasupervision: face-api models loaded"),!0}catch(n){return t.error("camerasupervision: error loading face-api models: "+n),a.alert("Error","No se pudieron cargar los modelos de reconocimiento facial","OK"),!1}}async function i(e){try{var a=await o.detectSingleFace(e,new o.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();return a?Array.from(a.descriptor):null}catch(n){return t.error("camerasupervision: error detecting face: "+n),null}}async function s(){try{n=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}},audio:!1});var t=document.getElementById("camera-video");return t.srcObject=n,e("#camera-container").show(),e("#btn-start-camera").hide(),e("#btn-capture").show(),e("#btn-stop-camera").show(),!0}catch(o){return t.error("camerasupervision: error starting camera: "+o),a.alert("Error","No se pudo acceder a la cámara: "+o.name,"OK"),!1}}function c(){n&&(n.getTracks().forEach(function(e){e.stop()}),n=null);var t=document.getElementById("camera-video");t&&(t.srcObject=null),e("#camera-container").hide(),e("#btn-start-camera").show(),e("#btn-capture").hide(),e("#btn-stop-camera").hide()}async function d(){var a=document.getElementById("camera-video"),n=document.getElementById("camera-canvas");if(!a||!n){alert("Error: Elementos no encontrados");return}n.width=a.videoWidth,n.height=a.videoHeight;var o=n.getContext("2d");o.drawImage(a,0,0,n.width,n.height),e("#capture-status").html('<div class="alert alert-info">Procesando imagen...</div>');var r=await i(n);if(!r){e("#capture-status").html('<div class="alert alert-danger">No se detectó ningún rostro en la imagen. Por favor, intenta de nuevo asegurándote de que tu rostro esté bien iluminado y centrado.</div>');return}var s=n.toDataURL("image/png"),d=e("#capture-userid").val(),l=e("#capture-sesskey").val();e("#capture-status").html('<div class="alert alert-info">Guardando foto...</div>');var u=new FormData;u.append("userid",d),u.append("image",s),u.append("descriptor",JSON.stringify(r)),u.append("sesskey",l);try{var m=await fetch(M.cfg.wwwroot+"/mod/quiz/accessrule/camerasupervision/upload_face.php",{method:"POST",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},body:u}),f=await m.json();"ok"===f.status?(e("#capture-status").html('<div class="alert alert-success"><i class="fa fa-check-circle"></i> '+f.message+"</div>"),setTimeout(function(){window.location.reload()},2e3)):e("#capture-status").html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> '+f.message+"</div>")}catch(p){t.error("camerasupervision: error uploading photo: "+p),e("#capture-status").html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> Error al guardar la foto</div>')}}async function l(e){return new Promise(function(t,a){var n=new FileReader;n.onload=async function(n){var o=new Image;o.onload=async function(){var e=await i(o);e?t(e):a(Error("No se detectó rostro en la imagen"))},o.onerror=function(){a(Error("Error al cargar la imagen"))},o.src=n.target.result},n.onerror=function(){a(Error("Error al leer el archivo"))},n.readAsDataURL(e)})}function u(t,a){var n="alert-info",o="fa-info-circle";"success"===a?(n="alert-success",o="fa-check-circle"):"error"===a?(n="alert-danger",o="fa-times-circle"):"warning"===a&&(n="alert-warning",o="fa-exclamation-triangle");var r=e("#upload-status");0===r.length&&(r=e('<div id="upload-status" class="mt-3"></div>'),e("#upload-form").after(r)),r.html('<div class="alert '+n+'"><i class="fa '+o+'"></i> '+t+"</div>")}return{init:async function(){if(t.debug("camerasupervision: facemanager init"),await r()){e("#btn-start-camera").on("click",async function(){await s()}),e("#btn-stop-camera").on("click",function(){c()}),e("#btn-capture").on("click",async function(){await d()}),e("#upload-form").on("submit",async function(t){var a=e("#photofile")[0];if(!a||!a.files||!a.files[0])return!0;t.preventDefault();var n=e(this).find('input[type="submit"]');n.prop("disabled",!0).val("Procesando..."),u("Procesando imagen...","info");try{var o=await l(a.files[0]);u("Rostro detectado correctamente. Subiendo foto...","success");var r=e(this);r.find('input[name="descriptor"]').remove(),e("<input>").attr({type:"hidden",name:"descriptor",value:JSON.stringify(o)}).appendTo(r),r.off("submit").submit()}catch(i){u(i.message,"error"),n.prop("disabled",!1).val("Subir")}return!1})}}});
