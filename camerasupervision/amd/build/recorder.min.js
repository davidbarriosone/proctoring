define(["core/log","core/notification"],function(e,t){function a(e){try{t.alert("Supervisi\xf3n por c\xe1mara",e,"OK")}catch(a){window.alert(e)}}function n(t,a,n,i,r){var o=new FormData;o.append("attemptid",t),o.append("eventtype",a),o.append("eventdata",n),o.append("sesskey",r),fetch(i,{method:"POST",credentials:"same-origin",body:o}).catch(function(t){e.debug("camerasupervision: log event error "+t)})}return{init:function(t,i,r,o,d){try{var s,c,p,u,l,g;if(!document.body.classList.contains("path-mod-quiz"))return;s=t,c=r,p=o,u=d,l=Date.now(),g=!0,u.detectRightClick&&document.addEventListener("contextmenu",function(t){n(s,"rightclick","Click derecho detectado en: "+(t.target.tagName||"desconocido"),c,p),e.debug("camerasupervision: right click detected")}),u.detectTabChange&&document.addEventListener("visibilitychange",function(){if(document.hidden)g=!1,n(s,"tabchange","Estudiante cambi\xf3 de pesta\xf1a o minimiz\xf3 el navegador",c,p),e.debug("camerasupervision: tab changed - page hidden");else{var t=Math.round((Date.now()-l)/1e3);g=!0,n(s,"tabreturn","Estudiante regres\xf3 a la pesta\xf1a despu\xe9s de "+t+" segundos",c,p),e.debug("camerasupervision: returned to tab")}}),u.detectAppChange&&(window.addEventListener("blur",function(){l=Date.now(),n(s,"appchange","Estudiante cambi\xf3 a otra aplicaci\xf3n o ventana",c,p),e.debug("camerasupervision: window lost focus")}),window.addEventListener("focus",function(){if(g){var t=Math.round((Date.now()-l)/1e3);t>2&&(n(s,"appreturn","Estudiante regres\xf3 despu\xe9s de "+t+" segundos",c,p),e.debug("camerasupervision: window regained focus"))}})),u.detectRightClick&&document.addEventListener("keydown",function(e){123===e.keyCode&&(n(s,"devtools","Intento de abrir herramientas de desarrollador (F12)",c,p),e.preventDefault()),e.ctrlKey&&e.shiftKey&&(73===e.keyCode||74===e.keyCode||67===e.keyCode)&&(n(s,"devtools","Intento de abrir herramientas de desarrollador (atajo de teclado)",c,p),e.preventDefault()),e.ctrlKey&&85===e.keyCode&&(n(s,"viewsource","Intento de ver c\xf3digo fuente (Ctrl+U)",c,p),e.preventDefault())}),setTimeout(function(){!function t(i,r,o,d,s){if(!window.isSecureContext){a("No se pudo activar la c\xe1mara porque el sitio no usa HTTPS. Por seguridad del navegador, la c\xe1mara solo puede usarse en HTTPS o localhost."),e.debug("camerasupervision: insecure context (no HTTPS)");return}if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){a("Este navegador no soporta acceso a c\xe1mara (getUserMedia no disponible)."),e.debug("camerasupervision: mediaDevices/getUserMedia not available");return}var c,p,u,l,g,v,h,m=((c=document.createElement("div")).id="camera-preview-container",c.style.cssText="position: fixed;bottom: 20px;right: 20px;width: 240px;background: #fff;border: 3px solid #28a745;border-radius: 8px;box-shadow: 0 4px 12px rgba(0,0,0,0.3);z-index: 9998;overflow: hidden;",(p=document.createElement("div")).style.cssText="background: #28a745;color: white;padding: 8px 12px;font-size: 13px;font-weight: bold;display: flex;align-items: center;justify-content: space-between;",(u=document.createElement("span")).innerHTML='<span style="display: inline-block; width: 8px; height: 8px; background: #fff; border-radius: 50%; margin-right: 8px; animation: blink 1.5s infinite;"></span>Supervisi\xf3n activa',(l=document.createElement("button")).innerHTML="−",l.style.cssText="background: transparent;border: none;color: white;font-size: 20px;cursor: pointer;padding: 0;width: 24px;height: 24px;line-height: 20px;",p.appendChild(u),p.appendChild(l),(g=document.createElement("video")).id="camera-preview-video",g.setAttribute("autoplay",!0),g.setAttribute("playsinline",!0),g.setAttribute("muted",!0),g.style.cssText="width: 100%;display: block;background: #000;",c.appendChild(p),c.appendChild(g),document.body.appendChild(c),(v=document.createElement("style")).textContent="@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }",document.head.appendChild(v),h=!1,l.addEventListener("click",function(){(h=!h)?(g.style.display="none",c.style.width="180px",l.innerHTML="+"):(g.style.display="block",c.style.width="240px",l.innerHTML="−")}),{video:g,container:c}),b=m.video,f=m.container,$=null,y=null;window.addEventListener("beforeunload",function e(){try{y&&clearInterval(y),$&&$.getTracks().forEach(function(e){e.stop()}),f&&f.parentNode&&f.parentNode.removeChild(f)}catch(t){}}),navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(function(t){$=t,b.srcObject=t,n(i,"camerastart","C\xe1mara iniciada correctamente",o,d),y=setInterval(function(){try{if(!b.videoWidth||!b.videoHeight)return;var t,a,n=(t=b,(a=document.createElement("canvas")).width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height),a.toDataURL("image/png")),o=new FormData;o.append("attemptid",i),o.append("image",n),o.append("sesskey",d),fetch(r,{method:"POST",credentials:"same-origin",body:o}).catch(function(t){e.debug("camerasupervision: upload error "+t)})}catch(s){e.debug("camerasupervision: snapshot error "+s)}},3e4)}).catch(function(t){var r=t&&t.name?t.name:""+t;a("No se pudo activar la c\xe1mara: "+r+". Revisa permisos del navegador o usa HTTPS."),e.debug("camerasupervision: cannot start camera "+r),f&&f.parentNode&&f.parentNode.removeChild(f),n(i,"cameraerror","Error al iniciar c\xe1mara: "+r,o,d)})}(t,i,r,o,d)},1200)}catch(v){e.debug("camerasupervision init error: "+v)}}}});
