define(["jquery","core/log","core/notification"],function(e,t,a){var n=null,i=null,r=[],o=.6,s=!1;async function c(){if(!window.faceapi)return!1;i=window.faceapi;try{var e="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model";return await i.nets.tinyFaceDetector.loadFromUri(e),await i.nets.faceLandmark68Net.loadFromUri(e),await i.nets.faceRecognitionNet.loadFromUri(e),!0}catch(a){return t.error("camerasupervision: error loading models: "+a),!1}}async function d(e){try{var a=await fetch(M.cfg.wwwroot+"/mod/quiz/accessrule/camerasupervision/get_descriptors.php?userid="+e,{method:"GET",credentials:"same-origin"}),n=await a.json();return"ok"===n.status&&n.descriptors&&n.descriptors.length>0?(r=n.descriptors.map(function(e){return new Float32Array(e)}),!0):!1}catch(i){return t.error("camerasupervision: error loading descriptors: "+i),!1}}function l(e){if(0===r.length)return{match:!1,distance:1};for(var t=1,a=0;a<r.length;a++){var n=i.euclideanDistance(e,r[a]);n<t&&(t=n)}var s=t<o;return{match:s,distance:t,similarity:(1-t)*100}}async function u(a){try{e("#verification-status").html('<div class="alert alert-info">Analizando rostro...</div>');var n=await i.detectSingleFace(a,new i.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();if(!n)return e("#verification-status").html('<div class="alert alert-warning">No se detectó ningún rostro. Por favor, asegúrate de que tu rostro esté bien iluminado y centrado en la cámara.</div>'),!1;var r=l(n.descriptor);if(r.match)return e("#verification-status").html('<div class="alert alert-success"><strong>✓ Verificación exitosa</strong><br>Similitud: '+r.similarity.toFixed(1)+"%<br>Puedes continuar con el examen.</div>"),e("#face_verification_passed").val("1"),e('input[name="face_verification_passed"]').val("1"),s=!0,await f("success",r.similarity),!0;e("#verification-status").html('<div class="alert alert-danger"><strong>✗ Verificación fallida</strong><br>No se pudo confirmar tu identidad (similitud: '+r.similarity.toFixed(1)+"%)<br>Por favor, intenta de nuevo o contacta a tu profesor.</div>"),e("#face_verification_passed").val("0"),e('input[name="face_verification_passed"]').val("0"),s=!1,await f("failed",r.similarity)}catch(o){return t.error("camerasupervision: error verifying face: "+o),e("#verification-status").html('<div class="alert alert-danger">Error al verificar el rostro</div>'),!1}}async function f(e,a){try{var n=new FormData;n.append("eventtype","faceverification_"+e),n.append("eventdata","Similitud: "+a.toFixed(2)+"%"),n.append("sesskey",M.cfg.sesskey),await fetch(M.cfg.wwwroot+"/mod/quiz/accessrule/camerasupervision/log_preflight_event.php",{method:"POST",credentials:"same-origin",body:n})}catch(i){t.error("camerasupervision: error logging verification event: "+i)}}async function m(){try{n=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}},audio:!1});var t=document.getElementById("verification-video");return t.srcObject=n,e("#verification-camera-container").show(),e("#btn-start-verification").hide(),e("#btn-verify-face").show(),e("#btn-stop-verification").show(),!0}catch(i){return t.error("camerasupervision: error starting verification camera: "+i),a.alert("Error","No se pudo acceder a la cámara: "+i.name,"OK"),!1}}function v(){n&&(n.getTracks().forEach(function(e){e.stop()}),n=null);var t=document.getElementById("verification-video");t&&(t.srcObject=null),e("#verification-camera-container").hide(),e("#btn-start-verification").show(),e("#btn-verify-face").hide(),e("#btn-stop-verification").hide()}async function g(){var t=document.getElementById("verification-video"),n=document.getElementById("verification-canvas");t&&n&&(n.width=t.videoWidth,n.height=t.videoHeight,n.getContext("2d").drawImage(t,0,0,n.width,n.height),await u(n))}function p(){e('form[action*="startattempt.php"]').on("submit",function(t){var n=e('input[name="face_verification_passed"]').val();if("1"!==n&&!s)return t.preventDefault(),a.alert("Verificación requerida","Debes completar la verificación facial antes de iniciar el examen.","OK"),!1})}return{init:async function(a,n){if(o=n||.6,await c()){if(await d(a)){e("#verification-status").html('<div class="alert alert-info">Sistema de verificación listo. Haz clic en "Iniciar cámara" para comenzar.</div>'),e("#btn-start-verification").on("click",async function(){await m()}),e("#btn-stop-verification").on("click",function(){v()}),e("#btn-verify-face").on("click",async function(){await g()}),p()}else e("#verification-status").html('<div class="alert alert-warning">No se encontraron fotos de referencia para tu perfil.<br>Por favor, contacta a tu profesor para registrar tus fotos.</div>'),e('input[type="submit"]').prop("disabled",!0)}else e("#verification-status").html('<div class="alert alert-danger">Error al cargar los modelos de reconocimiento facial</div>')}}});
